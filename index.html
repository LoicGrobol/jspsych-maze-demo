<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>

    <script src="https://unpkg.com/@jspsych/plugin-maze"></script>
    <script src="jspsych-plugin-maze/jspsych-maze.js"></script>

    <!-- Ugly trick to keep the data separate while not having to think of how to fetch it. See the
    jatos version for an example of how to use fetch -->
    <script src="stimuli.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/jspsych/css/jspsych.css" />
  </head>

  <body></body>
  <script>
    // Data-processing phase: all of this depends on how you manage your stimuli. This is an example
    // of how to select a random group of sentences and shuffles them.
    const jsPsych = initJsPsych({
      on_finish: () => {
        jsPsych.data.displayData("json");
      },
    });
    const all_groups = [...new Set(data.map(({ group, ..._ }) => group))];
    const group = jsPsych.randomization.sampleWithoutReplacement(
      all_groups,
      1
    )[0];
    const trials = jsPsych.randomization.shuffle(
      data.filter(({ group: g, ..._ }) => group == g)
    );

    // Just to help people testing this demo, the plugin doesn't need instructions per se
    const instructions = {
      type: jsPsychInstructions,
      pages: [
        `Press <span style="color: red;">J</span> to advance.`,
        "In this experiment we are interested in seeing how quickly you<br>can decide what the best way is to continue a sentence.",
        "You will see two words, one on the left and one on the right.<br>One word will be obviously wrong.",
        "It is your job to decide which word is the correct continuation of the sentence.",
        `Press <span style="color: red;">F</span> if the correct answer is on the left, or <span style="color: red;">J</span> if the correct answer is on the right.`,
        "You should do this as quickly and accurately as possible.",
        "You will then answer a question about that sentence.",
        `When you are ready, press <span style="color: red;">J</span> to do a practice run.`,
      ],
      allow_keys: true,
      key_backward: "f",
      key_forward: "j",
      show_clickable_nav: false,
    };

    // The actual maze experiment
    const procedure = {
      timeline: [
        {
          type: jsPsychMaze,
          sentence: jsPsych.timelineVariable("sentence"),
          inter_word_interval: 100,
          pre_answer_interval: 200,
          halt_on_error: true,
          post_trial_gap: 500,
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: () => jsPsych.evaluateTimelineVariable("question").text,
          choices: ["f", "j"],
          prompt: () => `
            <span style="margin: 5em 8em 0 8em; display: inline-block;">${
              jsPsych.evaluateTimelineVariable("question").left
            }</span>
            <span style="margin: 5em 8em 0 8em; display: inline-block;">${
              jsPsych.evaluateTimelineVariable("question").right
            }</span>`,
          on_finish: (data) => {
            success: jsPsych.pluginAPI.compareKeys(
              data.response,
              "left" === jsPsych.evaluateTimelineVariable("question").correct
                ? "f"
                : "j"
            );
          },
          post_trial_gap: 1000,
        },
      ],
      timeline_variables: trials,
      data: { group: group },
    };

    jsPsych.run([instructions, procedure]);
  </script>
</html>
